{"filter":false,"title":"bg.js","tooltip":"/bg.js","undoManager":{"mark":5,"position":5,"stack":[[{"start":{"row":0,"column":0},"end":{"row":58,"column":0},"action":"insert","lines":["var prefs = {};","","chrome.storage.local.get({callback: 'http://localhost:8080', key: 'chrome'}, function(o) { prefs = o; });","","chrome.storage.onChanged.addListener(function(changes) {","    for (key in changes) {","        prefs[key] = changes[key].newValue;","    }","});","","function log(url, title, favicon){","    var data = JSON.stringify({","        url: url, time: Date.now(),","        title: title, key: prefs.key,","        favicon: favicon","    });","    var xhr = new XMLHttpRequest();","    xhr.open(\"POST\", prefs.callback);","    xhr.send(data);","}","","chrome.tabs.onActivated.addListener(function (activeInfo) {","    chrome.tabs.get(activeInfo.tabId, function(tab) {","        if (tab.status === \"complete\" && tab.active) {","            chrome.windows.get(tab.windowId, {populate: false}, function(window) {","                if (window.focused) {","                    log(tab.url, tab.title, tab.favIconUrl || null);","                }","            });","        }","    });","});","","chrome.tabs.onUpdated.addListener(function (tabId, changeInfo, tab) {","    if (changeInfo.status === \"complete\" && tab.active) {","        chrome.windows.get(tab.windowId, {populate: false}, function(window) {","            if (window.focused) {","                log(tab.url, tab.title, tab.favIconUrl || null);","            }","        });","    }","});","","chrome.windows.onFocusChanged.addListener(function (windowId) {","    if (windowId == chrome.windows.WINDOW_ID_NONE) {","        log(null, null, null);","    } else {","        chrome.windows.get(windowId, {populate: true}, function(window) {","            if (window.focused) {","                chrome.tabs.query({active: true, windowId: windowId}, function (tabs) {","                    if (tabs[0].status === \"complete\") {","                        log(tabs[0].url, tabs[0].title, tabs[0].favIconUrl || null);","                    }","                });","            }","        });","    }","});",""],"id":1}],[{"start":{"row":57,"column":3},"end":{"row":58,"column":0},"action":"remove","lines":["",""],"id":2}],[{"start":{"row":0,"column":0},"end":{"row":57,"column":3},"action":"remove","lines":["var prefs = {};","","chrome.storage.local.get({callback: 'http://localhost:8080', key: 'chrome'}, function(o) { prefs = o; });","","chrome.storage.onChanged.addListener(function(changes) {","    for (key in changes) {","        prefs[key] = changes[key].newValue;","    }","});","","function log(url, title, favicon){","    var data = JSON.stringify({","        url: url, time: Date.now(),","        title: title, key: prefs.key,","        favicon: favicon","    });","    var xhr = new XMLHttpRequest();","    xhr.open(\"POST\", prefs.callback);","    xhr.send(data);","}","","chrome.tabs.onActivated.addListener(function (activeInfo) {","    chrome.tabs.get(activeInfo.tabId, function(tab) {","        if (tab.status === \"complete\" && tab.active) {","            chrome.windows.get(tab.windowId, {populate: false}, function(window) {","                if (window.focused) {","                    log(tab.url, tab.title, tab.favIconUrl || null);","                }","            });","        }","    });","});","","chrome.tabs.onUpdated.addListener(function (tabId, changeInfo, tab) {","    if (changeInfo.status === \"complete\" && tab.active) {","        chrome.windows.get(tab.windowId, {populate: false}, function(window) {","            if (window.focused) {","                log(tab.url, tab.title, tab.favIconUrl || null);","            }","        });","    }","});","","chrome.windows.onFocusChanged.addListener(function (windowId) {","    if (windowId == chrome.windows.WINDOW_ID_NONE) {","        log(null, null, null);","    } else {","        chrome.windows.get(windowId, {populate: true}, function(window) {","            if (window.focused) {","                chrome.tabs.query({active: true, windowId: windowId}, function (tabs) {","                    if (tabs[0].status === \"complete\") {","                        log(tabs[0].url, tabs[0].title, tabs[0].favIconUrl || null);","                    }","                });","            }","        });","    }","});"],"id":3},{"start":{"row":0,"column":0},"end":{"row":59,"column":0},"action":"insert","lines":["var _gaq = _gaq || [];","_gaq.push(['_setAccount', 'UA-45267314-2']);","_gaq.push(['_trackPageview']);","","(function() {","  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;","  ga.src = 'https://ssl.google-analytics.com/ga.js';","  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);","})();","","function clearStats() {","  if (config.clearStatsInterval < 3600) {","    config.nextTimeToClear = 0;","    return;","  }","","  if (!config.nextTimeToClear) {","    var d = new Date();","    d.setTime(d.getTime() + config.clearStatsInterval * 1000);","    d.setMinutes(0);","    d.setSeconds(0);","    if (config.clearStatsInterval > 3600) {","      d.setHours(0);","    }","    config.nextTimeToClear = d.getTime();","  }","  var now = new Date();","  if (now.getTime() > config.nextTimeToClear) {","    sites.clear();","    var nextTimeToClear = new Date(nextTimeToClear + config.clearStatsInterval * 1000);","    config.nextTimeToClear = nextTimeToClear.getTime();","    return;","  }","}","","var config = new Config();","var sites = new Sites(config);","var tracker = new Tracker(config, sites);","","/* Listen for requests which come from the user through the popup. */","chrome.extension.onRequest.addListener(","  function(request, sender, sendResponse) {","    if (request.action == \"clearStats\") {","      sites.clear();","      sendResponse({});","    } else if (request.action == \"addIgnoredSite\") {","      config.addIgnoredSite(request.site);","      sendResponse({});","    } else {","      console.log(\"Invalid action given: \" + request.action);","    }","  });","","chrome.alarms.create(\"clearStats\", {periodInMinutes: 2});","chrome.alarms.onAlarm.addListener(function(alarm) {","  if (alarm.name == \"clearStats\") {","    clearStats(config);","  }","});",""]}],[{"start":{"row":58,"column":3},"end":{"row":59,"column":0},"action":"remove","lines":["",""],"id":4}],[{"start":{"row":0,"column":0},"end":{"row":9,"column":0},"action":"remove","lines":["var _gaq = _gaq || [];","_gaq.push(['_setAccount', 'UA-45267314-2']);","_gaq.push(['_trackPageview']);","","(function() {","  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;","  ga.src = 'https://ssl.google-analytics.com/ga.js';","  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);","})();",""],"id":5}],[{"start":{"row":0,"column":0},"end":{"row":1,"column":0},"action":"remove","lines":["",""],"id":6}]]},"ace":{"folds":[],"scrolltop":0,"scrollleft":0,"selection":{"start":{"row":0,"column":0},"end":{"row":0,"column":0},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1488716292265,"hash":"7cff3dfc1e651621b8ac63c922f1ea9e268a2adc"}